name: Setup Tailscale on Ubuntu

on:
  workflow_call:
    inputs:
      authkey:
        required: false
        type: string
        description: 'Tailscale Authkey. If provided, tailscale will be started.'
        default: ''
  workflow_dispatch:
    inputs:
        authkey:
          required: false
          type: string
          description: 'Tailscale Authkey. If provided, tailscale will be started.'
          default: ''

jobs:
  setup-tailscale:
    runs-on: ubuntu-latest
    steps:
      - name: Install tailscale
        run: |
          #!/bin/bash
          mkdir /home/runner/.ssh
          touch /home/runner/.ssh/known_hosts
          ssh-keygen -t rsa -q -f "/home/runner/.ssh/id_rsa" -N ""
          # Add the Tailscale GPG key
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/focal.gpg | sudo apt-key add -

          # Add the Tailscale repository
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/focal.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          
          # Update package list and install Tailscale
          sudo apt update
          sudo apt install -y tailscale
      - name: Start tailscale
        if: ${{ inputs.authkey != '' }}
        run: |
          sudo tailscale up --authkey ${{ inputs.authkey }}
          sudo tailscale status
